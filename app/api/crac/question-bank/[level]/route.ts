import { NextRequest, NextResponse } from 'next/server'
import { BaseResponse, ExamBankResponse, ExamLevel, ExamQuestion } from '@/app/api/types'
import { createHash } from 'crypto'
import { list } from '@vercel/blob'


const LKs = {
  A: [
    'LK0001',
    'LK0002',
    'LK0003',
    'LK0004',
    'LK0005',
    'LK0011',
    'LK0012',
    'LK0104',
    'LK0007',
    'LK0008',
    'LK0111',
    'LK0009',
    'LK0051',
    'LK0052',
    'LK0112',
    'LK0013',
    'LK0014',
    'LK0017',
    'LK0026',
    'LK0027',
    'LK0041',
    'LK0042',
    'LK0020',
    'LK0022',
    'LK0043',
    'LK0006',
    'LK0010',
    'LK0023',
    'LK0028',
    'LK0029',
    'LK0030',
    'LK0031',
    'LK0032',
    'LK0033',
    'LK0044',
    'LK0045',
    'LK0046',
    'LK0089',
    'LK0090',
    'LK0024',
    'LK0025',
    'LK0038',
    'LK0039',
    'LK0040',
    'LK0116',
    'LK0117',
    'LK0118',
    'LK0125',
    'LK0126',
    'LK0137',
    'LK0139',
    'LK0047',
    'LK0048',
    'LK0049',
    'LK0113',
    'LK0114',
    'LK0115',
    'LK0140',
    'LK0141',
    'LK0142',
    'LK0143',
    'LK1112',
    'LK1113',
    'LK1114',
    'LK0144',
    'LK0146',
    'LK0147',
    'LK0148',
    'LK0157',
    'LK0158',
    'LK0159',
    'LK0160',
    'LK0171',
    'LK0172',
    'LK1031',
    'LK1032',
    'LK0077',
    'LK0078',
    'LK0080',
    'LK0081',
    'LK0082',
    'LK0083',
    'LK0091',
    'LK0092',
    'LK1072',
    'LK0079',
    'LK0084',
    'LK0086',
    'LK0087',
    'LK0088',
    'LK0093',
    'LK0056',
    'LK0057',
    'LK0058',
    'LK0059',
    'LK0060',
    'LK0061',
    'LK0062',
    'LK0063',
    'LK0064',
    'LK0065',
    'LK0066',
    'LK0067',
    'LK0068',
    'LK0069',
    'LK0070',
    'LK0071',
    'LK0072',
    'LK0073',
    'LK0181',
    'LK0247',
    'LK1010',
    'LK0053',
    'LK0054',
    'LK0055',
    'LK0075',
    'LK0076',
    'LK1011',
    'LK1042',
    'LK0034',
    'LK0035',
    'LK0036',
    'LK0037',
    'LK0275',
    'LK1096',
    'LK0074',
    'LK0094',
    'LK0095',
    'LK0096',
    'LK0097',
    'LK0098',
    'LK0099',
    'LK0100',
    'LK0101',
    'LK0102',
    'LK0103',
    'LK0105',
    'LK0106',
    'LK0107',
    'LK0108',
    'LK0109',
    'LK0110',
    'LK0050',
    'LK0232',
    'LK0233',
    'LK0235',
    'LK0236',
    'LK0238',
    'LK0239',
    'LK0241',
    'LK0242',
    'LK0244',
    'LK0245',
    'LK1046',
    'LK1097',
    'LK1098',
    'LK1102',
    'LK1131',
    'LK0287',
    'LK0292',
    'LK0294',
    'LK0313',
    'LK0321',
    'LK0331',
    'LK0332',
    'LK0352',
    'LK0361',
    'LK0373',
    'LK0376',
    'LK0379',
    'LK0380',
    'LK0381',
    'LK0396',
    'LK0402',
    'LK0404',
    'LK0405',
    'LK0407',
    'LK0408',
    'LK0409',
    'LK0410',
    'LK0193',
    'LK0194',
    'LK0202',
    'LK0204',
    'LK0862',
    'LK0863',
    'LK0864',
    'LK1208',
    'LK0431',
    'LK0432',
    'LK0433',
    'LK0434',
    'LK0466',
    'LK0467',
    'LK0468',
    'LK0469',
    'LK0470',
    'LK0471',
    'LK0472',
    'LK0473',
    'LK0495',
    'LK0566',
    'LK0567',
    'LK0568',
    'LK0438',
    'LK0440',
    'LK0512',
    'LK0513',
    'LK0518',
    'LK0519',
    'LK0529',
    'LK0537',
    'LK0577',
    'LK1107',
    'LK1134',
    'LK1135',
    'LK1136',
    'LK1138',
    'LK1139',
    'LK1140',
    'LK0123',
    'LK0138',
    'LK0416',
    'LK0417',
    'LK0418',
    'LK0420',
    'LK0421',
    'LK0422',
    'LK0533',
    'LK0535',
    'LK0536',
    'LK0572',
    'LK0689',
    'LK0713',
    'LK0716',
    'LK0784',
    'LK0786',
    'LK0791',
    'LK0813',
    'LK0814',
    'LK0816',
    'LK0819',
    'LK0854',
    'LK1044',
    'LK1099',
    'LK1100',
    'LK1177',
    'LK1180',
    'LK1202',
    'LK1203',
    'LK0702',
    'LK0904',
    'LK0910',
    'LK0918',
    'LK0919',
    'LK0925',
    'LK0926',
    'LK0929',
    'LK0930',
    'LK0931',
    'LK0932',
    'LK0933',
    'LK1062',
    'LK1063',
    'LK1126',
    'LK1173',
    'LK1183',
    'LK1184',
    'LK1185',
    'LK1186',
    'LK1188',
    'LK1189',
    'LK1190',
    'LK1191',
    'LK1211',
    'LK1213',
    'LK1216',
    'LK1217',
    'LK1218',
    'LK1219',
    'LK1221',
    'LK1222',
    'LK1223',
    'LK1224',
    'LK0972',
    'LK0973',
    'LK0974',
    'LK1058',
    'LK1060',
    'LK1067',
    'LK1068',
    'LK1104',
    'LK1106',
    'LK1108',
    'LK1109',
    'LK1110',
    'LK1111',
    'LK1115',
    'LK1116',
    'LK1143',
    'LK1144',
    'LK0255',
    'LK0258',
    'LK0259',
    'LK0260',
    'LK0261',
    'LK0262',
    'LK0783',
    'LK0788',
    'LK0789',
    'LK0790',
    'LK0855',
    'LK0898',
    'LK0971',
    'LK1065',
    'LK1130',
    'LK1182',
    'LK1237',
    'LK0436',
    'LK0482',
    'LK0483',
    'LK0691',
    'LK1064',
    'LK1122',
    'LK1137',
    'LK1151',
    'LK1153',
    'LK1154',
    'LK1162',
    'LK1163',
    'LK1167',
    'LK1169',
    'LK1170',
    'LK1192',
    'LK1193',
    'LK1194',
    'LK1195',
    'LK1196',
    'LK1206',
    'LK1229',
    'LK1231',
    'LK1235',
    'LK0996',
    'LK0997',
    'LK0998',
    'LK0999',
    'LK1000',
    'LK1001',
    'LK1039',
    'LK1040',
    'LK1043',
    'LK1225',
    'LK1226',
    'LK1227',
    'LK1228',
    'LK1230',
    'LK1233',
    'LK1234',
    'LK0574',
    'LK0575',
    'LK1002',
    'LK1003',
    'LK1009',
    'LK1128',
    'LK1236',
  ],
  B: [
    'LK0001',
    'LK0002',
    'LK0003',
    'LK0004',
    'LK0005',
    'LK0011',
    'LK0012',
    'LK0104',
    'LK0007',
    'LK0008',
    'LK0111',
    'LK0183',
    'LK0187',
    'LK0026',
    'LK0041',
    'LK0042',
    'LK0010',
    'LK0028',
    'LK0029',
    'LK0032',
    'LK0033',
    'LK0044',
    'LK0045',
    'LK0046',
    'LK0024',
    'LK0025',
    'LK0038',
    'LK0039',
    'LK0040',
    'LK0116',
    'LK0117',
    'LK0118',
    'LK0137',
    'LK0139',
    'LK0047',
    'LK0048',
    'LK0049',
    'LK0113',
    'LK0114',
    'LK0115',
    'LK0119',
    'LK0140',
    'LK0141',
    'LK0142',
    'LK0143',
    'LK0173',
    'LK0174',
    'LK0231',
    'LK0144',
    'LK0145',
    'LK0146',
    'LK0147',
    'LK0148',
    'LK0157',
    'LK0158',
    'LK0159',
    'LK0160',
    'LK0171',
    'LK0172',
    'LK1031',
    'LK1032',
    'LK0220',
    'LK0221',
    'LK0222',
    'LK0223',
    'LK0224',
    'LK0225',
    'LK0226',
    'LK0227',
    'LK0212',
    'LK0213',
    'LK0214',
    'LK0215',
    'LK0216',
    'LK0217',
    'LK0218',
    'LK0219',
    'LK0150',
    'LK0151',
    'LK0152',
    'LK0153',
    'LK0154',
    'LK0155',
    'LK0156',
    'LK0162',
    'LK0163',
    'LK0164',
    'LK0165',
    'LK0166',
    'LK0167',
    'LK0168',
    'LK0169',
    'LK0170',
    'LK0263',
    'LK0272',
    'LK1033',
    'LK0077',
    'LK0078',
    'LK0080',
    'LK0081',
    'LK0082',
    'LK0083',
    'LK0089',
    'LK0090',
    'LK0091',
    'LK0092',
    'LK1072',
    'LK0079',
    'LK0084',
    'LK0086',
    'LK0087',
    'LK0088',
    'LK0093',
    'LK0127',
    'LK0128',
    'LK0129',
    'LK0130',
    'LK0132',
    'LK0056',
    'LK0057',
    'LK0058',
    'LK0059',
    'LK0060',
    'LK0061',
    'LK0062',
    'LK0063',
    'LK0064',
    'LK0065',
    'LK0066',
    'LK0067',
    'LK0068',
    'LK0069',
    'LK0070',
    'LK0071',
    'LK0072',
    'LK0073',
    'LK0181',
    'LK0247',
    'LK1010',
    'LK0034',
    'LK0035',
    'LK0036',
    'LK0037',
    'LK0053',
    'LK0054',
    'LK0055',
    'LK0075',
    'LK0076',
    'LK0177',
    'LK0275',
    'LK1011',
    'LK1041',
    'LK1042',
    'LK1096',
    'LK0074',
    'LK0094',
    'LK0095',
    'LK0096',
    'LK0097',
    'LK0098',
    'LK0099',
    'LK0100',
    'LK0101',
    'LK0102',
    'LK0103',
    'LK0105',
    'LK0106',
    'LK0107',
    'LK0108',
    'LK0109',
    'LK0110',
    'LK0015',
    'LK0018',
    'LK0020',
    'LK0815',
    'LK0050',
    'LK0232',
    'LK0233',
    'LK0234',
    'LK0236',
    'LK0237',
    'LK0238',
    'LK0239',
    'LK0241',
    'LK0242',
    'LK0244',
    'LK0245',
    'LK0248',
    'LK1036',
    'LK1046',
    'LK1071',
    'LK1097',
    'LK1098',
    'LK1102',
    'LK1131',
    'LK0285',
    'LK0286',
    'LK0287',
    'LK0288',
    'LK0289',
    'LK0290',
    'LK0291',
    'LK0292',
    'LK0293',
    'LK0295',
    'LK0296',
    'LK0297',
    'LK0298',
    'LK0299',
    'LK0300',
    'LK0301',
    'LK0302',
    'LK0303',
    'LK0304',
    'LK0305',
    'LK0313',
    'LK0321',
    'LK0294',
    'LK0306',
    'LK0307',
    'LK0308',
    'LK0309',
    'LK0310',
    'LK0311',
    'LK0312',
    'LK0314',
    'LK0315',
    'LK0316',
    'LK0317',
    'LK0318',
    'LK0319',
    'LK0320',
    'LK0322',
    'LK0323',
    'LK0324',
    'LK0325',
    'LK0326',
    'LK0327',
    'LK0328',
    'LK0329',
    'LK0330',
    'LK0331',
    'LK0332',
    'LK0333',
    'LK0334',
    'LK0335',
    'LK0336',
    'LK0337',
    'LK0338',
    'LK0339',
    'LK0340',
    'LK0341',
    'LK0342',
    'LK0343',
    'LK0344',
    'LK0345',
    'LK0346',
    'LK0347',
    'LK0348',
    'LK0349',
    'LK0352',
    'LK0361',
    'LK0373',
    'LK0376',
    'LK0350',
    'LK0351',
    'LK0353',
    'LK0354',
    'LK0355',
    'LK0356',
    'LK0357',
    'LK0358',
    'LK0359',
    'LK0360',
    'LK0362',
    'LK0363',
    'LK0364',
    'LK0365',
    'LK0366',
    'LK0367',
    'LK0368',
    'LK0369',
    'LK0370',
    'LK0371',
    'LK0372',
    'LK0374',
    'LK0375',
    'LK0377',
    'LK0379',
    'LK0380',
    'LK0381',
    'LK0396',
    'LK0402',
    'LK0404',
    'LK0229',
    'LK0378',
    'LK0382',
    'LK0383',
    'LK0384',
    'LK0385',
    'LK0386',
    'LK0387',
    'LK0388',
    'LK0389',
    'LK0390',
    'LK0391',
    'LK0392',
    'LK0393',
    'LK0394',
    'LK0395',
    'LK0397',
    'LK0398',
    'LK0399',
    'LK0400',
    'LK0401',
    'LK0403',
    'LK0405',
    'LK0406',
    'LK0407',
    'LK0408',
    'LK0409',
    'LK0410',
    'LK0411',
    'LK0785',
    'LK0189',
    'LK0190',
    'LK0191',
    'LK0192',
    'LK0193',
    'LK0194',
    'LK0195',
    'LK0196',
    'LK0198',
    'LK0199',
    'LK0200',
    'LK0201',
    'LK0202',
    'LK0203',
    'LK0204',
    'LK0205',
    'LK0862',
    'LK0863',
    'LK0864',
    'LK1073',
    'LK1076',
    'LK1089',
    'LK1208',
    'LK0255',
    'LK0258',
    'LK0259',
    'LK0260',
    'LK0261',
    'LK0262',
    'LK0783',
    'LK0788',
    'LK0789',
    'LK0790',
    'LK0855',
    'LK0898',
    'LK0971',
    'LK1065',
    'LK1122',
    'LK1130',
    'LK1182',
    'LK1237',
    'LK0246',
    'LK0249',
    'LK0250',
    'LK0251',
    'LK0252',
    'LK0253',
    'LK0254',
    'LK0256',
    'LK0257',
    'LK0264',
    'LK0265',
    'LK0271',
    'LK0273',
    'LK0704',
    'LK1029',
    'LK1030',
    'LK1129',
    'LK1133',
    'LK0182',
    'LK0186',
    'LK0284',
    'LK0693',
    'LK0696',
    'LK0799',
    'LK0884',
    'LK0885',
    'LK0886',
    'LK0889',
    'LK0894',
    'LK0897',
    'LK0808',
    'LK0809',
    'LK0810',
    'LK0867',
    'LK0871',
    'LK0496',
    'LK0841',
    'LK0842',
    'LK0843',
    'LK0844',
    'LK0845',
    'LK0846',
    'LK0848',
    'LK0425',
    'LK0426',
    'LK0427',
    'LK0428',
    'LK0429',
    'LK0430',
    'LK0474',
    'LK0475',
    'LK0476',
    'LK0530',
    'LK0531',
    'LK0532',
    'LK0441',
    'LK0442',
    'LK0443',
    'LK0444',
    'LK0445',
    'LK0446',
    'LK0447',
    'LK0448',
    'LK0449',
    'LK0450',
    'LK0451',
    'LK0452',
    'LK0453',
    'LK0454',
    'LK0455',
    'LK0456',
    'LK0524',
    'LK0525',
    'LK0526',
    'LK0527',
    'LK0528',
    'LK0589',
    'LK0590',
    'LK0591',
    'LK0592',
    'LK0593',
    'LK0650',
    'LK0653',
    'LK0697',
    'LK1145',
    'LK1146',
    'LK1147',
    'LK1148',
    'LK1149',
    'LK1150',
    'LK1152',
    'LK1155',
    'LK1156',
    'LK1157',
    'LK1159',
    'LK1168',
    'LK1171',
    'LK1172',
    'LK0497',
    'LK0498',
    'LK0499',
    'LK0500',
    'LK0501',
    'LK0502',
    'LK0503',
    'LK0504',
    'LK0505',
    'LK0506',
    'LK0507',
    'LK0508',
    'LK0509',
    'LK0510',
    'LK0511',
    'LK0615',
    'LK0617',
    'LK0619',
    'LK0620',
    'LK0621',
    'LK0622',
    'LK0623',
    'LK0624',
    'LK0625',
    'LK0628',
    'LK0629',
    'LK0630',
    'LK0631',
    'LK0638',
    'LK0687',
    'LK0688',
    'LK0748',
    'LK0749',
    'LK0750',
    'LK0751',
    'LK0752',
    'LK0753',
    'LK0754',
    'LK0759',
    'LK0760',
    'LK0761',
    'LK0762',
    'LK0763',
    'LK0781',
    'LK0278',
    'LK0419',
    'LK0423',
    'LK0424',
    'LK0663',
    'LK0664',
    'LK0665',
    'LK0787',
    'LK0804',
    'LK1045',
    'LK1050',
    'LK1051',
    'LK1052',
    'LK1053',
    'LK1054',
    'LK1055',
    'LK1056',
    'LK1209',
    'LK0677',
    'LK0678',
    'LK0679',
    'LK0690',
    'LK0770',
    'LK0771',
    'LK0772',
    'LK0773',
    'LK0774',
    'LK0775',
    'LK0534',
    'LK0569',
    'LK0570',
    'LK0571',
    'LK0585',
    'LK0586',
    'LK0705',
    'LK0706',
    'LK0709',
    'LK0710',
    'LK0711',
    'LK0712',
    'LK0722',
    'LK1015',
    'LK1204',
    'LK0686',
    'LK0820',
    'LK0831',
    'LK0832',
    'LK0838',
    'LK0839',
    'LK0856',
    'LK0857',
    'LK0858',
    'LK0859',
    'LK1066',
    'LK0457',
    'LK0458',
    'LK0459',
    'LK0460',
    'LK0461',
    'LK0538',
    'LK0539',
    'LK0540',
    'LK0541',
    'LK0542',
    'LK0543',
    'LK0544',
    'LK0545',
    'LK0546',
    'LK0547',
    'LK0548',
    'LK0549',
    'LK0550',
    'LK0551',
    'LK0552',
    'LK0553',
    'LK0554',
    'LK0555',
    'LK0556',
    'LK0557',
    'LK0558',
    'LK0559',
    'LK0560',
    'LK0561',
    'LK0562',
    'LK0563',
    'LK0564',
    'LK0565',
    'LK0880',
    'LK0881',
    'LK0903',
    'LK0905',
    'LK0906',
    'LK0916',
    'LK0917',
    'LK1034',
    'LK1057',
    'LK1214',
    'LK0206',
    'LK0207',
    'LK0927',
    'LK0928',
    'LK0946',
    'LK0947',
    'LK0948',
    'LK0949',
    'LK0988',
    'LK0989',
    'LK0991',
    'LK0920',
    'LK0921',
    'LK0922',
    'LK0923',
    'LK0934',
    'LK1035',
    'LK1069',
    'LK1210',
    'LK1215',
    'LK0667',
    'LK0668',
    'LK0669',
    'LK0908',
    'LK0909',
    'LK0911',
    'LK0936',
    'LK0937',
    'LK0938',
    'LK1125',
    'LK1187',
    'LK1220',
    'LK0960',
    'LK0961',
    'LK0962',
    'LK0964',
    'LK0966',
    'LK0967',
    'LK0968',
    'LK1048',
    'LK1049',
    'LK1059',
    'LK1061',
    'LK1105',
    'LK0437',
    'LK0477',
    'LK0487',
    'LK0489',
    'LK0849',
    'LK1199',
    'LK0996',
    'LK0997',
    'LK0998',
    'LK0999',
    'LK1000',
    'LK1001',
    'LK1039',
    'LK1040',
    'LK1043',
    'LK1225',
    'LK1226',
    'LK1227',
    'LK1228',
    'LK1230',
    'LK1232',
    'LK1233',
    'LK1234',
    'LK1002',
    'LK1003',
    'LK1009',
    'LK1236',
    'LK0573',
    'LK0574',
    'LK0575',
    'LK0576',
    'LK0685',
    'LK0860',
    'LK1101',
    'LK1123',
    'LK1124',
    'LK1127',
    'LK1128',
    'LK1132',
    'LK1181',
    'LK1206',
  ],
  C: [
    'LK0001',
    'LK0002',
    'LK0003',
    'LK0004',
    'LK0005',
    'LK0011',
    'LK0012',
    'LK0104',
    'LK0007',
    'LK0008',
    'LK0111',
    'LK0183',
    'LK0187',
    'LK0026',
    'LK0041',
    'LK0042',
    'LK0010',
    'LK0028',
    'LK0029',
    'LK0032',
    'LK0033',
    'LK0044',
    'LK0045',
    'LK0046',
    'LK0024',
    'LK0025',
    'LK0038',
    'LK0039',
    'LK0040',
    'LK0116',
    'LK0117',
    'LK0118',
    'LK0125',
    'LK0126',
    'LK0137',
    'LK0139',
    'LK0047',
    'LK0048',
    'LK0049',
    'LK0113',
    'LK0114',
    'LK0115',
    'LK0119',
    'LK0136',
    'LK0140',
    'LK0141',
    'LK0142',
    'LK0143',
    'LK0173',
    'LK0174',
    'LK0231',
    'LK0144',
    'LK0145',
    'LK0146',
    'LK0147',
    'LK0148',
    'LK0157',
    'LK0158',
    'LK0159',
    'LK0160',
    'LK0171',
    'LK0172',
    'LK1031',
    'LK1032',
    'LK0220',
    'LK0221',
    'LK0222',
    'LK0223',
    'LK0224',
    'LK0225',
    'LK0226',
    'LK0227',
    'LK0212',
    'LK0213',
    'LK0214',
    'LK0215',
    'LK0216',
    'LK0217',
    'LK0218',
    'LK0219',
    'LK0149',
    'LK0150',
    'LK0161',
    'LK0151',
    'LK0152',
    'LK0153',
    'LK0154',
    'LK0155',
    'LK0156',
    'LK0124',
    'LK0162',
    'LK0163',
    'LK0164',
    'LK0165',
    'LK0166',
    'LK0167',
    'LK0168',
    'LK0169',
    'LK0170',
    'LK0263',
    'LK0272',
    'LK1033',
    'LK0077',
    'LK0078',
    'LK0080',
    'LK0081',
    'LK0082',
    'LK0083',
    'LK0089',
    'LK0090',
    'LK0091',
    'LK0092',
    'LK1072',
    'LK0079',
    'LK0084',
    'LK0086',
    'LK0087',
    'LK0088',
    'LK0093',
    'LK0127',
    'LK0128',
    'LK0129',
    'LK0130',
    'LK0131',
    'LK0132',
    'LK0133',
    'LK0134',
    'LK0135',
    'LK0056',
    'LK0057',
    'LK0058',
    'LK0059',
    'LK0060',
    'LK0061',
    'LK0062',
    'LK0063',
    'LK0064',
    'LK0065',
    'LK0066',
    'LK0067',
    'LK0068',
    'LK0069',
    'LK0070',
    'LK0071',
    'LK0072',
    'LK0073',
    'LK0181',
    'LK0247',
    'LK1010',
    'LK0053',
    'LK0054',
    'LK0055',
    'LK0075',
    'LK0076',
    'LK1011',
    'LK1042',
    'LK0177',
    'LK0178',
    'LK0179',
    'LK0180',
    'LK0185',
    'LK1041',
    'LK0034',
    'LK0035',
    'LK0036',
    'LK0037',
    'LK0275',
    'LK1096',
    'LK0074',
    'LK0094',
    'LK0095',
    'LK0096',
    'LK0097',
    'LK0098',
    'LK0099',
    'LK0100',
    'LK0101',
    'LK0102',
    'LK0103',
    'LK0105',
    'LK0106',
    'LK0107',
    'LK0108',
    'LK0109',
    'LK0110',
    'LK0016',
    'LK0019',
    'LK0021',
    'LK0175',
    'LK0188',
    'LK0815',
    'LK0050',
    'LK0232',
    'LK0233',
    'LK0234',
    'LK0236',
    'LK0237',
    'LK0238',
    'LK0239',
    'LK0241',
    'LK0242',
    'LK0244',
    'LK0245',
    'LK1046',
    'LK1097',
    'LK1098',
    'LK1102',
    'LK1131',
    'LK0248',
    'LK0267',
    'LK0861',
    'LK0865',
    'LK1036',
    'LK1071',
    'LK1207',
    'LK0285',
    'LK0286',
    'LK0287',
    'LK0288',
    'LK0289',
    'LK0290',
    'LK0291',
    'LK0292',
    'LK0293',
    'LK0295',
    'LK0296',
    'LK0297',
    'LK0298',
    'LK0299',
    'LK0300',
    'LK0301',
    'LK0302',
    'LK0303',
    'LK0304',
    'LK0305',
    'LK0306',
    'LK0307',
    'LK0308',
    'LK0309',
    'LK0310',
    'LK0313',
    'LK0321',
    'LK0294',
    'LK0311',
    'LK0312',
    'LK0314',
    'LK0315',
    'LK0316',
    'LK0317',
    'LK0318',
    'LK0319',
    'LK0320',
    'LK0322',
    'LK0323',
    'LK0324',
    'LK0325',
    'LK0326',
    'LK0327',
    'LK0328',
    'LK0329',
    'LK0330',
    'LK0331',
    'LK0332',
    'LK0333',
    'LK0334',
    'LK0335',
    'LK0336',
    'LK0337',
    'LK0338',
    'LK0339',
    'LK0340',
    'LK0341',
    'LK0342',
    'LK0343',
    'LK0344',
    'LK0345',
    'LK0346',
    'LK0347',
    'LK0348',
    'LK0349',
    'LK0352',
    'LK0361',
    'LK0373',
    'LK0376',
    'LK0350',
    'LK0351',
    'LK0353',
    'LK0354',
    'LK0355',
    'LK0356',
    'LK0357',
    'LK0358',
    'LK0359',
    'LK0360',
    'LK0362',
    'LK0363',
    'LK0364',
    'LK0365',
    'LK0366',
    'LK0367',
    'LK0368',
    'LK0369',
    'LK0370',
    'LK0371',
    'LK0372',
    'LK0374',
    'LK0375',
    'LK0377',
    'LK0379',
    'LK0380',
    'LK0381',
    'LK0396',
    'LK0402',
    'LK0404',
    'LK0229',
    'LK0378',
    'LK0382',
    'LK0383',
    'LK0384',
    'LK0385',
    'LK0386',
    'LK0387',
    'LK0388',
    'LK0389',
    'LK0390',
    'LK0391',
    'LK0392',
    'LK0393',
    'LK0394',
    'LK0395',
    'LK0397',
    'LK0398',
    'LK0399',
    'LK0400',
    'LK0401',
    'LK0403',
    'LK0405',
    'LK0406',
    'LK0407',
    'LK0408',
    'LK0409',
    'LK0410',
    'LK0411',
    'LK0785',
    'LK0189',
    'LK0190',
    'LK0191',
    'LK0192',
    'LK0193',
    'LK0194',
    'LK0195',
    'LK0196',
    'LK0198',
    'LK0199',
    'LK0200',
    'LK0201',
    'LK0202',
    'LK0203',
    'LK0204',
    'LK0205',
    'LK0862',
    'LK0863',
    'LK0864',
    'LK1073',
    'LK1076',
    'LK1089',
    'LK1208',
    'LK0255',
    'LK0258',
    'LK0259',
    'LK0260',
    'LK0261',
    'LK0262',
    'LK0783',
    'LK0788',
    'LK0789',
    'LK0790',
    'LK0855',
    'LK0898',
    'LK0971',
    'LK1065',
    'LK1122',
    'LK1130',
    'LK1182',
    'LK1237',
    'LK0246',
    'LK0249',
    'LK0250',
    'LK0251',
    'LK0252',
    'LK0253',
    'LK0254',
    'LK0256',
    'LK0257',
    'LK0264',
    'LK0265',
    'LK0266',
    'LK0268',
    'LK0269',
    'LK0270',
    'LK0271',
    'LK0273',
    'LK0704',
    'LK0782',
    'LK0853',
    'LK1029',
    'LK1030',
    'LK1088',
    'LK1129',
    'LK1133',
    'LK0983',
    'LK0984',
    'LK1078',
    'LK1080',
    'LK1092',
    'LK1093',
    'LK1094',
    'LK0282',
    'LK0283',
    'LK0284',
    'LK0797',
    'LK0798',
    'LK0799',
    'LK0800',
    'LK0801',
    'LK0802',
    'LK0803',
    'LK0805',
    'LK0197',
    'LK0882',
    'LK0883',
    'LK0884',
    'LK0885',
    'LK0886',
    'LK0887',
    'LK0888',
    'LK0889',
    'LK0895',
    'LK0896',
    'LK0897',
    'LK1037',
    'LK0890',
    'LK0891',
    'LK0892',
    'LK0893',
    'LK0894',
    'LK0900',
    'LK1074',
    'LK1075',
    'LK1077',
    'LK1084',
    'LK1085',
    'LK1079',
    'LK1081',
    'LK1082',
    'LK1083',
    'LK1090',
    'LK1091',
    'LK1095',
    'LK0182',
    'LK0184',
    'LK0186',
    'LK0646',
    'LK0647',
    'LK0692',
    'LK0693',
    'LK0694',
    'LK0695',
    'LK0696',
    'LK0425',
    'LK0426',
    'LK0427',
    'LK0428',
    'LK0429',
    'LK0430',
    'LK0435',
    'LK0439',
    'LK0441',
    'LK0442',
    'LK0443',
    'LK0444',
    'LK0445',
    'LK0446',
    'LK0447',
    'LK0448',
    'LK0449',
    'LK0450',
    'LK0451',
    'LK0452',
    'LK0453',
    'LK0454',
    'LK0455',
    'LK0456',
    'LK0524',
    'LK0525',
    'LK0526',
    'LK0527',
    'LK0528',
    'LK0474',
    'LK0475',
    'LK0476',
    'LK0514',
    'LK0515',
    'LK0516',
    'LK0517',
    'LK0520',
    'LK0521',
    'LK0522',
    'LK0523',
    'LK0530',
    'LK0531',
    'LK0532',
    'LK0412',
    'LK0413',
    'LK0414',
    'LK0415',
    'LK0587',
    'LK0588',
    'LK0698',
    'LK0699',
    'LK0700',
    'LK0723',
    'LK0724',
    'LK0725',
    'LK0726',
    'LK0727',
    'LK0728',
    'LK0729',
    'LK0730',
    'LK0731',
    'LK1155',
    'LK1156',
    'LK1157',
    'LK1158',
    'LK1159',
    'LK1160',
    'LK1161',
    'LK1164',
    'LK1165',
    'LK1166',
    'LK1172',
    'LK0578',
    'LK0579',
    'LK0580',
    'LK0581',
    'LK0582',
    'LK0583',
    'LK0584',
    'LK0589',
    'LK0590',
    'LK0591',
    'LK0640',
    'LK0641',
    'LK0642',
    'LK0643',
    'LK0644',
    'LK0645',
    'LK0666',
    'LK0670',
    'LK1038',
    'LK1145',
    'LK1146',
    'LK1147',
    'LK1148',
    'LK1150',
    'LK1152',
    'LK1168',
    'LK0592',
    'LK0593',
    'LK0632',
    'LK0633',
    'LK0634',
    'LK0635',
    'LK0648',
    'LK0649',
    'LK0650',
    'LK0651',
    'LK0652',
    'LK0653',
    'LK0671',
    'LK0672',
    'LK0673',
    'LK0674',
    'LK0697',
    'LK1141',
    'LK1142',
    'LK1149',
    'LK1171',
    'LK0497',
    'LK0498',
    'LK0499',
    'LK0500',
    'LK0501',
    'LK0502',
    'LK0503',
    'LK0504',
    'LK0505',
    'LK0506',
    'LK0507',
    'LK0508',
    'LK0509',
    'LK0510',
    'LK0511',
    'LK0594',
    'LK0595',
    'LK0596',
    'LK0597',
    'LK0598',
    'LK0599',
    'LK0600',
    'LK0601',
    'LK0602',
    'LK0603',
    'LK0604',
    'LK0605',
    'LK0606',
    'LK0607',
    'LK0608',
    'LK0609',
    'LK0610',
    'LK0611',
    'LK0612',
    'LK0613',
    'LK0614',
    'LK0734',
    'LK0735',
    'LK0736',
    'LK0615',
    'LK0616',
    'LK0617',
    'LK0618',
    'LK0619',
    'LK0620',
    'LK0621',
    'LK0622',
    'LK0623',
    'LK0624',
    'LK0625',
    'LK0626',
    'LK0627',
    'LK0628',
    'LK0629',
    'LK0630',
    'LK0631',
    'LK0636',
    'LK0637',
    'LK0638',
    'LK0639',
    'LK0675',
    'LK0676',
    'LK0677',
    'LK0678',
    'LK0679',
    'LK0680',
    'LK1014',
    'LK0687',
    'LK0688',
    'LK0763',
    'LK0764',
    'LK0780',
    'LK0781',
    'LK1016',
    'LK0732',
    'LK0733',
    'LK0737',
    'LK0738',
    'LK0739',
    'LK0740',
    'LK0741',
    'LK0742',
    'LK0743',
    'LK0744',
    'LK0745',
    'LK0748',
    'LK0749',
    'LK0750',
    'LK0751',
    'LK0752',
    'LK0753',
    'LK0754',
    'LK0755',
    'LK0756',
    'LK0757',
    'LK0758',
    'LK0759',
    'LK0760',
    'LK0761',
    'LK0762',
    'LK1017',
    'LK1018',
    'LK1019',
    'LK1020',
    'LK1021',
    'LK1022',
    'LK1023',
    'LK1024',
    'LK1025',
    'LK1026',
    'LK1027',
    'LK1028',
    'LK0278',
    'LK0419',
    'LK0423',
    'LK0424',
    'LK0654',
    'LK0655',
    'LK0656',
    'LK0657',
    'LK0658',
    'LK0659',
    'LK0660',
    'LK0661',
    'LK0662',
    'LK0663',
    'LK0664',
    'LK0665',
    'LK0708',
    'LK0787',
    'LK0792',
    'LK0793',
    'LK0794',
    'LK0795',
    'LK0796',
    'LK0804',
    'LK0812',
    'LK1045',
    'LK1050',
    'LK1051',
    'LK1052',
    'LK1053',
    'LK1054',
    'LK1055',
    'LK1056',
    'LK1174',
    'LK1176',
    'LK1200',
    'LK1201',
    'LK1209',
    'LK0690',
    'LK0765',
    'LK0766',
    'LK0767',
    'LK0768',
    'LK0769',
    'LK0770',
    'LK0771',
    'LK0772',
    'LK0773',
    'LK0774',
    'LK0775',
    'LK0776',
    'LK0777',
    'LK0778',
    'LK0779',
    'LK0806',
    'LK0807',
    'LK0808',
    'LK0809',
    'LK0810',
    'LK0811',
    'LK0867',
    'LK0868',
    'LK0869',
    'LK0870',
    'LK0871',
    'LK0120',
    'LK0121',
    'LK0122',
    'LK0176',
    'LK0276',
    'LK0277',
    'LK1204',
    'LK0569',
    'LK0570',
    'LK0571',
    'LK0585',
    'LK0586',
    'LK0705',
    'LK0706',
    'LK0707',
    'LK1015',
    'LK0534',
    'LK0714',
    'LK0715',
    'LK0717',
    'LK0718',
    'LK0719',
    'LK0720',
    'LK0721',
    'LK0709',
    'LK0710',
    'LK0711',
    'LK0712',
    'LK0722',
    'LK0866',
    'LK0681',
    'LK0682',
    'LK0683',
    'LK0686',
    'LK0817',
    'LK0818',
    'LK0820',
    'LK0821',
    'LK0822',
    'LK0823',
    'LK0824',
    'LK0825',
    'LK0826',
    'LK0827',
    'LK0828',
    'LK0829',
    'LK0830',
    'LK0831',
    'LK0832',
    'LK0833',
    'LK0834',
    'LK0835',
    'LK0836',
    'LK0837',
    'LK0838',
    'LK0839',
    'LK0850',
    'LK0851',
    'LK0852',
    'LK1066',
    'LK0279',
    'LK0280',
    'LK0281',
    'LK0684',
    'LK0703',
    'LK0746',
    'LK0747',
    'LK0856',
    'LK0857',
    'LK0858',
    'LK0859',
    'LK1070',
    'LK1178',
    'LK0496',
    'LK0840',
    'LK0841',
    'LK0842',
    'LK0843',
    'LK0844',
    'LK0845',
    'LK0846',
    'LK0847',
    'LK0848',
    'LK1175',
    'LK0457',
    'LK0458',
    'LK0459',
    'LK0460',
    'LK0461',
    'LK0462',
    'LK0463',
    'LK0464',
    'LK0465',
    'LK0538',
    'LK0539',
    'LK0540',
    'LK0541',
    'LK0542',
    'LK0543',
    'LK0544',
    'LK0545',
    'LK0546',
    'LK0547',
    'LK0548',
    'LK0549',
    'LK0550',
    'LK0551',
    'LK0552',
    'LK0553',
    'LK0554',
    'LK0555',
    'LK0556',
    'LK0557',
    'LK0558',
    'LK0559',
    'LK0560',
    'LK0561',
    'LK0562',
    'LK0563',
    'LK0564',
    'LK0565',
    'LK0880',
    'LK0881',
    'LK0903',
    'LK0905',
    'LK0906',
    'LK0907',
    'LK0916',
    'LK0917',
    'LK1034',
    'LK1057',
    'LK1214',
    'LK0206',
    'LK0207',
    'LK0927',
    'LK0928',
    'LK0946',
    'LK0947',
    'LK0948',
    'LK0949',
    'LK0950',
    'LK0951',
    'LK0952',
    'LK0953',
    'LK0954',
    'LK0955',
    'LK0956',
    'LK0957',
    'LK0958',
    'LK0959',
    'LK0988',
    'LK0989',
    'LK0990',
    'LK0991',
    'LK0992',
    'LK0993',
    'LK0994',
    'LK0995',
    'LK1212',
    'LK0920',
    'LK0921',
    'LK0922',
    'LK0923',
    'LK0934',
    'LK1035',
    'LK1069',
    'LK1210',
    'LK1215',
    'LK0208',
    'LK0209',
    'LK0210',
    'LK0211',
    'LK0924',
    'LK0935',
    'LK0939',
    'LK0940',
    'LK0941',
    'LK0942',
    'LK0943',
    'LK0944',
    'LK0945',
    'LK0701',
    'LK0911',
    'LK0912',
    'LK0913',
    'LK0914',
    'LK0915',
    'LK1187',
    'LK0667',
    'LK0668',
    'LK0669',
    'LK0908',
    'LK0909',
    'LK0936',
    'LK0937',
    'LK0938',
    'LK1125',
    'LK1220',
    'LK0228',
    'LK0872',
    'LK0873',
    'LK0874',
    'LK0875',
    'LK0876',
    'LK0877',
    'LK0878',
    'LK0879',
    'LK0975',
    'LK0976',
    'LK0977',
    'LK0978',
    'LK0979',
    'LK0980',
    'LK0981',
    'LK0982',
    'LK0960',
    'LK0961',
    'LK0962',
    'LK0963',
    'LK0964',
    'LK0965',
    'LK0966',
    'LK0967',
    'LK0968',
    'LK0969',
    'LK0970',
    'LK1048',
    'LK1049',
    'LK1059',
    'LK1061',
    'LK1086',
    'LK1087',
    'LK1103',
    'LK1105',
    'LK0899',
    'LK0901',
    'LK0902',
    'LK0985',
    'LK0986',
    'LK0987',
    'LK1047',
    'LK1117',
    'LK1118',
    'LK1119',
    'LK1120',
    'LK0437',
    'LK0477',
    'LK0478',
    'LK0479',
    'LK0480',
    'LK0481',
    'LK0484',
    'LK0485',
    'LK0486',
    'LK0487',
    'LK0488',
    'LK0489',
    'LK0490',
    'LK0491',
    'LK0492',
    'LK0493',
    'LK0494',
    'LK0849',
    'LK1197',
    'LK1198',
    'LK1199',
    'LK0996',
    'LK0997',
    'LK0998',
    'LK0999',
    'LK1000',
    'LK1001',
    'LK1039',
    'LK1040',
    'LK1043',
    'LK1225',
    'LK1226',
    'LK1227',
    'LK1228',
    'LK1230',
    'LK1232',
    'LK1233',
    'LK1234',
    'LK1002',
    'LK1003',
    'LK1009',
    'LK1236',
    'LK0573',
    'LK0574',
    'LK0575',
    'LK0576',
    'LK0685',
    'LK0860',
    'LK1101',
    'LK1123',
    'LK1124',
    'LK1127',
    'LK1128',
    'LK1132',
    'LK1181',
    'LK1206',
  ],
}

const CRAC_BANK_SOURCE = process.env.HS_CRAC_BANK_SOURCE || 'upyun'
const UPYUN_BUCKET = process.env.HS_UPYUN_BUCKET || 'http://hamset.test.upcdn.net'

async function getServerSideProps() {
  const SPLIT_ITEM = '\r\n\r\n'
  try {
    const blobs = (await list({prefix: 'crac/questionBank/'})).blobs
    const getBankBlob = (level: ExamLevel) => blobs.find(b => b.pathname === `crac/questionBank/${level}.txt`)

    const fetchBankItem = async (url: string) => (await (await fetch(url, {cache: 'force-cache'})).text()).trim().split(SPLIT_ITEM)

    const rowItems = CRAC_BANK_SOURCE === 'vercel' ? {
      A: await fetchBankItem(getBankBlob('A')!.url),
      B: await fetchBankItem(getBankBlob('B')!.url),
      C: await fetchBankItem(getBankBlob('C')!.url),
      FULL: await fetchBankItem(getBankBlob('FULL')!.url),
    } : {
      A: await fetchBankItem(`${UPYUN_BUCKET}/crac/exam/A.txt`),
      B: await fetchBankItem(`${UPYUN_BUCKET}/crac/exam/B.txt`),
      C: await fetchBankItem(`${UPYUN_BUCKET}/crac/exam/C.txt`),
      FULL: await fetchBankItem(`${UPYUN_BUCKET}/crac/exam/FULL.txt`),
    }

    const banks: {
      [key in ExamLevel]: ExamQuestion[]
    } = {
      A: rowItems['A'].map(parseItemToExamQuestion),
      B: rowItems['B'].map(parseItemToExamQuestion),
      C: rowItems['C'].map(parseItemToExamQuestion),
      FULL: rowItems['FULL'].map(parseItemToExamQuestion),
    }

    return {
      props: {
        banks,
      },
    }
  } catch (e: any) {
    return {
      props: {
        banks: {
          'A': [],
          'B': [],
          'C': [],
          'FULL': [],
        },
      },
    }
  }
}

function parseItemToExamQuestion(item: string): ExamQuestion {
  const reg = /\[(?<id>\w)]\s*(?!\[\w])(?<content>.+)/gm
  const question = {
    options: [],
    picture: null,
    includeIn: [],
  } as unknown as ExamQuestion
  let m
  while ((m = reg.exec(item)) !== null) {
    if (m.index === reg.lastIndex) {
      reg.lastIndex++
    }

    switch (m.groups?.id) {
      case 'I':
        question.id = m.groups.content
        break
      case 'Q':
        question.question = m.groups.content.replace(/(?=\S+)(：)/, '')
        break
      case 'A':
      case 'B':
      case 'C':
      case 'D':
        question.options.push(m.groups.content)
        break
      case 'P':
        question.picture = m.groups.content
        break
    }
  }
  if (question.options.length !== 0) {
    question.answerIndex = 0
    question.answerHash = createHash('md5').update(question.options[0]?.toString() || '', 'utf-8').digest('hex')
  }
  return question
}

export async function GET(
  req: NextRequest,
  ctx: {
    params: {
      level: ExamLevel;
    }
  }): Promise<NextResponse<BaseResponse<ExamBankResponse>>> {
  const serverSideProps = await getServerSideProps()
  const searchParams = req.nextUrl.searchParams

  const questions: ExamQuestion[] = serverSideProps.props.banks[ctx.params.level].sort((a, b) => a.id.localeCompare(b.id))
  if (searchParams.get('shuffle') === 'true') {
    questions.sort(() => Math.random() - 0.5)
  }
  if (searchParams.get('shuffleOptions') === 'true') {
    questions.forEach(q => {
      const answer = q.options[q.answerIndex]
      q.options.sort(() => Math.random() - 0.5)
      q.answerIndex = q.options.indexOf(answer)
    })
  }
  questions.forEach(q => {
    for (let lKsKey in LKs) {
      if (LKs[lKsKey as Exclude<ExamLevel, 'FULL'>].includes(q.id)) {
        q.includeIn.push(lKsKey as Exclude<ExamLevel, 'FULL'>)
      }
    }
  })
  return NextResponse.json({
    code: 0,
    message: 'success',
    data: {
      level: ctx.params.level,
      levels: ['A', 'B', 'C', 'FULL'],
      questions,
    },
  })
}
